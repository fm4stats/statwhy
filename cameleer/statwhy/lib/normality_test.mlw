module Normality_test
  use cameleerBHL.CameleerBHL

  (* Based on scipy.stats.jarque_bera (https://docs.scipy.org/doc/scipy/reference/generated/scipy.stats.jarque_bera.html#scipy.stats.jarque_bera) *)
  val exec_jacque_bera_test (d : distribution) (y : dataset real) : real
  writes { st }
  requires {
    sampled y d /\ scale_leq Interval y.scale /\
    length y.data >= 2000 /\
    (World !st interp) |= Possible (Not (is_normal d))
  } ensures {
    let pv = result in
    pvalue result /\
    !st = Cons ("jacque_bera_test", (Not (is_normal d)), Eq pv) !(old st)
  }

  (* Based on scipy.stats.shapiro (https://docs.scipy.org/doc/scipy/reference/generated/scipy.stats.shapiro.html#scipy.stats.shapiro) *)
  val exec_shapiro_wilk_test (d : distribution) (y : dataset real) : real
  writes { st }
  requires {
    sampled y d /\ scale_leq Interval y.scale /\
    length y.data >= 5000 /\
    (World !st interp) |= Possible (Not (is_normal d))
  } ensures {
    let pv = result in
    pvalue result /\
    !st = Cons ("shapiro_wilk_test", (Not (is_normal d)), Eq pv) !(old st)
  }

  (* Based on scipy.stats.normaltest (https://docs.scipy.org/doc/scipy/reference/generated/scipy.stats.normaltest.html#scipy.stats.normaltest) *)
  val exec_normaltest (d : distribution) (y : dataset real) : real
  writes { st }
  requires {
    sampled y d /\ scale_leq Interval y.scale /\
    length y.data >= 8 /\
    (World !st interp) |= Possible (Not (is_normal d))
  } ensures {
    let pv = result in
    pvalue result /\
    !st = Cons ("normaltest", (Not (is_normal d)), Eq pv) !(old st)
  }
end
